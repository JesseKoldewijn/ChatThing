name: CI

on:
    push:
        branches: ["*"]
    pull_request:
        branches: ["*"]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Volta
              uses: volta-cli/action@v4

            - name: Install dependencies
              run: yarn install --immutable

            - name: Run ESLint
              run: yarn lint

    typecheck:
        name: Type Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Volta
              uses: volta-cli/action@v4

            - name: Install dependencies
              run: yarn install --immutable

            - name: Run TypeScript
              run: yarn tsc -b

    test:
        name: Unit Tests
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Volta
              uses: volta-cli/action@v4

            - name: Install dependencies
              run: yarn install --immutable

            - name: Run unit tests with coverage
              run: yarn test:coverage

            - name: Upload unit coverage artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-unit
                  path: |
                      coverage/unit/coverage-summary.json
                      coverage/unit/lcov.info

    test-e2e:
        name: E2E Tests
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Volta
              uses: volta-cli/action@v4

            - name: Install dependencies
              run: yarn install --immutable

            - name: Install Playwright browsers
              run: yarn playwright install --with-deps chromium

            - name: Run E2E tests with coverage
              run: yarn test:e2e:coverage

            - name: Upload E2E coverage artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-e2e
                  path: |
                      coverage/e2e/coverage-summary.json
                      coverage/e2e/lcov.info

    upload-coverage:
        name: Upload Coverage
        runs-on: ubuntu-latest
        needs: [test, test-e2e]
        if: github.event_name == 'push'
        permissions:
            contents: write
        concurrency:
            group: coverage-${{ github.ref }}
            cancel-in-progress: false
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.ref }}
                  fetch-depth: 0

            - name: Download unit coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-unit
                  path: coverage/unit/

            - name: Download E2E coverage
              uses: actions/download-artifact@v4
              with:
                  name: coverage-e2e
                  path: coverage/e2e/

            - name: Setup Volta
              uses: volta-cli/action@v4

            - name: Install dependencies
              run: yarn install --immutable

            - name: Generate coverage badges
              run: yarn test:badges

            - name: Commit and push coverage
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add coverage/unit/badge.svg coverage/unit/coverage-summary.json
                  git add coverage/e2e/badge.svg coverage/e2e/coverage-summary.json
                  if git diff --staged --quiet; then
                    echo "No coverage changes to commit"
                  else
                    git stash --include-untracked
                    git pull --rebase origin ${{ github.ref_name }}
                    git stash pop
                    git add coverage/unit/badge.svg coverage/unit/coverage-summary.json
                    git add coverage/e2e/badge.svg coverage/e2e/coverage-summary.json
                    git commit -m "chore: update coverage reports [skip ci]"
                    git push
                  fi

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [lint, typecheck, test]
        steps:
            - uses: actions/checkout@v4

            - name: Setup Volta
              uses: volta-cli/action@v4

            - name: Install dependencies
              run: yarn install --immutable

            - name: Build
              run: yarn build
